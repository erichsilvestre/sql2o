package org.sql2o;

import com.sun.org.apache.bcel.internal.generic.Select;
import junit.framework.Test;
import junit.framework.TestCase;

import javax.sound.midi.SysexMessage;
import java.sql.Timestamp;
import java.util.Date;
import java.util.HashMap;
import java.util.List;

/**
 * Created by IntelliJ IDEA.
 * User: lars
 * Date: 5/21/11
 * Time: 9:25 PM
 * To change this template use File | Settings | File Templates.
 */
public class Sql2oTestWithH2 extends TestCase {

    private String url = "jdbc:h2:mem:test;DB_CLOSE_DELAY=-1";
    private String user = "sa";
    private String pass = "";

    private Sql2o sql2o;

    private int insertIntoUsers = 0;

    public void setUp() throws Exception {
        this.sql2o = new Sql2o(this.url, this.user, this.pass);

        HashMap<String, String> defaultColumnMap = new HashMap<String,String>();
        defaultColumnMap.put("ID", "id");
        defaultColumnMap.put("NAME", "name");
        defaultColumnMap.put("EMAIL", "email");
        defaultColumnMap.put("TEXT", "text");
        defaultColumnMap.put("TS", "ts");
        defaultColumnMap.put("ANUMBER", "aNumber");
        defaultColumnMap.put("ALONGNUMBER", "aLongNumber");
        sql2o.setDefaultColumnMappings(defaultColumnMap);
    }

    public void tearDown() throws Exception {

    }
    
    public void testExecuteUpdate(){

    }

    public void testExecuteAndFetch(){
        createAndFillUserTable();

        Date before = new Date();
        List<User> allUsers = sql2o.createQuery("select * from User").executeAndFetch(User.class);
        Date after = new Date();
        long span = after.getTime() - before.getTime();
        System.out.println(String.format("Fetched %s user: %s ms", insertIntoUsers, span));

        assertTrue(allUsers.size() == insertIntoUsers);
    }

    public void testExecuteAndFetchWithNulls(){
//        String sql =
//                "create table testExecWithNullsTbl (" +
//                        "id int identity primary key, " +
//                        "text varchar(255), " +
//                        "aNumber int, " +
//                        "aLongNumber bigint)";
//        sql2o.createQuery(sql).executeUpdate();

        createTestTable("testExecWithNullsTbl");


        Query insQuery = sql2o.beginTransaction().createQuery("insert into testExecWithNullsTbl (text, aNumber, aLongNumber) values(:text, :number, :lnum)");
        insQuery.addParameter("text", "some text").addParameter("number", 2).addParameter("lnum", 10L).executeUpdate();
        insQuery.addParameter("text", "some text").addParameter("number", (Integer)null).addParameter("lnum", 10L).executeUpdate();
        insQuery.addParameter("text", (String)null).addParameter("number", 21).addParameter("lnum", (Long)null).executeUpdate();
        insQuery.addParameter("text", "some text").addParameter("number", 1221).addParameter("lnum", 10).executeUpdate();
        insQuery.addParameter("text", "some text").addParameter("number", 2311).addParameter("lnum", 12).executeUpdate();
        sql2o.commit();

        List<TestEntity> fetched = sql2o.createQuery("select id,text,aNumber,aLongNumber from testExecWithNullsTbl").executeAndFetch(TestEntity.class);

        assertTrue(fetched.size() == 5);
        assertNull(fetched.get(2).text);
        assertNotNull(fetched.get(3).text);

        assertNull(fetched.get(1).aNumber);
        assertNotNull(fetched.get(2).aNumber);

        assertNull(fetched.get(2).aLongNumber);
        assertNotNull(fetched.get(3).aLongNumber);
    }


    public void testComplexParameters(){
        createTestTable("complexParamsTbl");

        String sql =
            "insert into complexParamsTbl (text, aNumber, aLongNumber, time, ts)" +
            "values (@entity.text, @entity.aNumber, @entity.aLongNumber, @entity.time, @entity.ts)";
        TestEntity entity = new TestEntity();
        entity.text = "some test text";
        entity.time = new Date();
        entity.ts  = new Timestamp(new Date().getTime());
        entity.aNumber = 512;
        entity.aLongNumber = 204985l;

        sql2o.createQuery(sql).addParameter("entity", entity).executeUpdate();

        TestEntity refetched = sql2o.createQuery("select text, aNumber, aLongNumber, time, ts from complexParamsTbl").executeAndFetchFirst(TestEntity.class);

        assertEquals(entity, refetched);
    }


    /************** Helper stuff ******************/

    private void createAndFillUserTable(){
        sql2o.createQuery(
                "create table User(\n" +
                "id int identity primary key,\n" +
                "name varchar(20),\n" +
                "email varchar(255),\n" +
                "text varchar(100))").executeUpdate();

        Query insQuery = sql2o.beginTransaction().createQuery("insert into User(name, email, text) values (:name, :email, :text)");
        Date before = new Date();
        for (int idx = 0; idx < 10000; idx++){
            insQuery.addParameter("name", "a name " + idx)
                    .addParameter("email", String.format("test%s@email.com", idx))
                    .addParameter("text", "some text").executeUpdate();
        }
        sql2o.commit();
        Date after = new Date();
        Long span = after.getTime() - before.getTime();

        System.out.println(String.format("inserted 10000 rows into User table. Time used: %s ms", span));

        insertIntoUsers += 10000;
    }

    private void createTestTable(String tableName){

        String sql =
                "create table " + tableName + " (" +
                        "id int identity primary key, " +
                        "text varchar(255), " +
                        "time timestamp, " +
                        "ts timestamp, " +
                        "aNumber int, " +
                        "aLongNumber bigint)";
        sql2o.createQuery(sql).executeUpdate();
    }
}
